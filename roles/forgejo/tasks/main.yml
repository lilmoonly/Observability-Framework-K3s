---
- name: Create forgejo namespace
  become: true
  delegate_to: k8s-ctrl
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: forgejo

- name: Create Forgejo admin secret
  become: true
  delegate_to: k8s-ctrl
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: forgejo-admin-secret
        namespace: forgejo
      type: Opaque
      stringData:
        username: forgejo_admin
        password: "{{ forgejo.admin_password }}"

- name: Deploy Forgejo via OCI Helm chart
  become: true
  delegate_to: k8s-ctrl
  community.kubernetes.helm:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    name: forgejo
    chart_ref: oci://code.forgejo.org/forgejo-helm/forgejo
    release_namespace: forgejo
    create_namespace: false
    wait: yes
    values:
      gitea:
        admin:
          existingSecret: forgejo-admin-secret
        database:
          type: postgres
          host: app-db-cluster-rw.db.svc.cluster.local
          name: app
          user: appuser
          password: appuserpassword
        config:
          metrics:
            ENABLED: true
      persistence:
        enabled: true
        storageClass: local-path
      nodeSelector:
        workload: app
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "app"
          effect: "NoSchedule"
      service:
        http:
          type: LoadBalancer
          port: {{ forgejo.port }}