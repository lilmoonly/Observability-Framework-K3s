---
- name: Create forgejo namespace
  become: true
  delegate_to: k8s-ctrl
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: forgejo

- name: Wait for database to be ready
  become: true
  delegate_to: k8s-ctrl
  ansible.builtin.shell: |
    export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    kubectl wait --for=condition=Ready cluster/{{ database.cluster_name }} -n db --timeout=300s
  register: wait_db_result
  failed_when: wait_db_result.rc != 0

- name: Create Forgejo admin secret
  become: true
  delegate_to: k8s-ctrl
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: forgejo-admin-secret
        namespace: forgejo
      type: Opaque
      stringData:
        username: forgejo_admin
        password: "{{ forgejo.admin_password }}"

- name: Deploy Forgejo via OCI Helm chart
  become: true
  delegate_to: k8s-ctrl
  community.kubernetes.helm:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    name: forgejo
    chart_ref: oci://code.forgejo.org/forgejo-helm/forgejo
    release_namespace: forgejo
    create_namespace: false
    wait: yes
    values:
      gitea:
        admin:
          existingSecret: forgejo-admin-secret
        config:
          database:
            DB_TYPE: postgres
            HOST: app-db-cluster-rw.db.svc.cluster.local
            NAME: "{{ forgejo.db_name }}"
            USER: "{{ forgejo.db_user }}"
            PASSWD: "{{ forgejo.db_password }}"
          metrics:
            ENABLED: true
      persistence:
        enabled: true
        storageClass: local-path
      nodeSelector:
        workload: app
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "app"
          effect: "NoSchedule"
      service:
        http:
          type: LoadBalancer
          port: {{ forgejo.port }}